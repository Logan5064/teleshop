-- ========================================
-- üõçÔ∏è TeleShop Constructor - –ü–û–õ–ù–ê–Ø –°–•–ï–ú–ê –ë–î
-- ========================================
-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞

-- ===============================
-- 1. –û–°–ù–û–í–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
-- ===============================

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (—Å–æ–∑–¥–∞—Ç–µ–ª–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤)
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    telegram_id VARCHAR(50) UNIQUE NOT NULL,
    username VARCHAR(100),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    email VARCHAR(255),
    phone VARCHAR(50),
    is_active BOOLEAN DEFAULT TRUE,
    subscription_plan VARCHAR(20) DEFAULT 'free',
    subscription_expires_at TIMESTAMP WITH TIME ZONE,
    last_login TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Telegram (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
CREATE TABLE IF NOT EXISTS telegram_user_profiles (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    telegram_id VARCHAR(50) UNIQUE NOT NULL,
    username VARCHAR(100),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    language_code VARCHAR(10),
    is_premium BOOLEAN DEFAULT FALSE,
    photo_url TEXT,
    bio TEXT,
    first_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    total_logins INTEGER DEFAULT 1
);

-- –ö–æ–¥—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
CREATE TABLE IF NOT EXISTS auth_codes (
    id SERIAL PRIMARY KEY,
    code VARCHAR(6) UNIQUE NOT NULL,
    telegram_id VARCHAR(50) NOT NULL,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    telegram_username VARCHAR(100),
    telegram_first_name VARCHAR(100),
    telegram_last_name VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    used_at TIMESTAMP WITH TIME ZONE,
    is_used BOOLEAN DEFAULT FALSE
);

-- –°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE IF NOT EXISTS user_sessions (
    id SERIAL PRIMARY KEY,
    session_token VARCHAR(64) UNIQUE NOT NULL,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    telegram_id VARCHAR(50) NOT NULL,
    ip_address VARCHAR(50),
    user_agent TEXT,
    device_info JSON,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    last_activity TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE
);

-- ===============================
-- 2. –ü–û–î–ü–ò–°–ö–ò –ò –ü–õ–ê–¢–ï–ñ–ò
-- ===============================

-- –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫
CREATE TABLE IF NOT EXISTS subscription_plans (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    currency VARCHAR(10) DEFAULT 'RUB',
    duration_days INTEGER NOT NULL,
    features JSON,
    max_shops INTEGER,
    max_products INTEGER,
    max_orders INTEGER,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE IF NOT EXISTS user_subscriptions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    plan_id INTEGER NOT NULL REFERENCES subscription_plans(id),
    starts_at TIMESTAMP WITH TIME ZONE NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    auto_renew BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ü–ª–∞—Ç–µ–∂–∏
CREATE TABLE IF NOT EXISTS payments (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    subscription_id INTEGER REFERENCES user_subscriptions(id),
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(10) DEFAULT 'RUB',
    status VARCHAR(50) DEFAULT 'pending',
    payment_method VARCHAR(50),
    payment_system_id VARCHAR(100),
    payment_data JSON,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE
);

-- ===============================
-- 3. –ú–ê–ì–ê–ó–ò–ù–´ –ò –î–ò–ó–ê–ô–ù
-- ===============================

-- –ú–∞–≥–∞–∑–∏–Ω—ã
CREATE TABLE IF NOT EXISTS shops (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    logo_url VARCHAR(500),
    
    -- Bot –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    bot_token VARCHAR(100),
    bot_username VARCHAR(100),
    bot_webhook_url VARCHAR(500),
    is_bot_active BOOLEAN DEFAULT FALSE,
    bot_settings JSON,
    
    -- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    domain_slug VARCHAR(100) UNIQUE,
    is_published BOOLEAN DEFAULT FALSE,
    published_at TIMESTAMP WITH TIME ZONE,
    currency VARCHAR(10) DEFAULT 'RUB',
    language VARCHAR(10) DEFAULT 'ru',
    timezone VARCHAR(50) DEFAULT 'Europe/Moscow',
    
    -- SEO –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    seo_settings JSON,
    integrations JSON,
    blocks_structure JSON,
    
    -- –ë–∏–∑–Ω–µ—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    contact_email VARCHAR(255),
    contact_phone VARCHAR(50),
    address TEXT,
    working_hours JSON,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- –î–∏–∑–∞–π–Ω—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤
CREATE TABLE IF NOT EXISTS shop_designs (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER UNIQUE NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    primary_color VARCHAR(7) DEFAULT '#3b82f6',
    secondary_color VARCHAR(7) DEFAULT '#1e40af',
    accent_color VARCHAR(7) DEFAULT '#ef4444',
    background_color VARCHAR(7) DEFAULT '#ffffff',
    text_color VARCHAR(7) DEFAULT '#1f2937',
    font_family VARCHAR(100) DEFAULT 'Inter',
    theme_name VARCHAR(50) DEFAULT 'modern',
    custom_css TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- –ë–∞–Ω–Ω–µ—Ä—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤
CREATE TABLE IF NOT EXISTS shop_banners (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    title VARCHAR(255),
    subtitle VARCHAR(255),
    description TEXT,
    image_url VARCHAR(500),
    background_color VARCHAR(7),
    text_color VARCHAR(7),
    button_text VARCHAR(100),
    button_url VARCHAR(500),
    button_action VARCHAR(100),
    position INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–æ–≤
CREATE TABLE IF NOT EXISTS shop_navigation (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    parent_id INTEGER REFERENCES shop_navigation(id),
    title VARCHAR(255) NOT NULL,
    url VARCHAR(500),
    icon VARCHAR(100),
    position INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 4. –¢–û–í–ê–†–´ –ò –ö–ê–¢–ï–ì–û–†–ò–ò
-- ===============================

-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
CREATE TABLE IF NOT EXISTS shop_categories (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    parent_id INTEGER REFERENCES shop_categories(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    emoji VARCHAR(10),
    image_url VARCHAR(500),
    slug VARCHAR(255),
    position INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    seo_title VARCHAR(255),
    seo_description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- –¢–æ–≤–∞—Ä—ã
CREATE TABLE IF NOT EXISTS products (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    category_id INTEGER REFERENCES shop_categories(id) ON DELETE SET NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    short_description VARCHAR(500),
    price DECIMAL(10,2) NOT NULL,
    old_price DECIMAL(10,2),
    cost_price DECIMAL(10,2),
    currency VARCHAR(10) DEFAULT 'RUB',
    
    -- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –º–µ–¥–∏–∞
    image_url VARCHAR(500),
    images JSON,
    video_url VARCHAR(500),
    
    -- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
    is_available BOOLEAN DEFAULT TRUE,
    stock_quantity INTEGER,
    track_stock BOOLEAN DEFAULT FALSE,
    min_quantity INTEGER DEFAULT 1,
    max_quantity INTEGER,
    
    -- –ê—Ç—Ä–∏–±—É—Ç—ã
    sku VARCHAR(100),
    barcode VARCHAR(100),
    slug VARCHAR(255),
    weight DECIMAL(8,2),
    dimensions JSON,
    tags JSON,
    specifications JSON,
    variants JSON,
    
    -- SEO
    seo_title VARCHAR(255),
    seo_description TEXT,
    
    -- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    views_count INTEGER DEFAULT 0,
    orders_count INTEGER DEFAULT 0,
    rating DECIMAL(3,2) DEFAULT 0,
    reviews_count INTEGER DEFAULT 0,
    
    -- –°—Ç–∞—Ç—É—Å—ã
    is_featured BOOLEAN DEFAULT FALSE,
    is_digital BOOLEAN DEFAULT FALSE,
    requires_shipping BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- –í–∞—Ä–∏–∞–Ω—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤ (—Ä–∞–∑–º–µ—Ä—ã, —Ü–≤–µ—Ç–∞ –∏ —Ç.–¥.)
CREATE TABLE IF NOT EXISTS product_variants (
    id SERIAL PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    value VARCHAR(255) NOT NULL,
    price_modifier DECIMAL(10,2) DEFAULT 0,
    stock_quantity INTEGER,
    sku VARCHAR(100),
    image_url VARCHAR(500),
    is_default BOOLEAN DEFAULT FALSE,
    position INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –û—Ç–∑—ã–≤—ã –Ω–∞ —Ç–æ–≤–∞—Ä—ã
CREATE TABLE IF NOT EXISTS product_reviews (
    id SERIAL PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    user_telegram_id VARCHAR(50) NOT NULL,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    order_id INTEGER REFERENCES orders(id),
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    title VARCHAR(255),
    comment TEXT,
    pros TEXT,
    cons TEXT,
    images JSON,
    is_verified BOOLEAN DEFAULT FALSE,
    is_approved BOOLEAN DEFAULT FALSE,
    helpful_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 5. –ó–ê–ö–ê–ó–´ –ò –ö–û–†–ó–ò–ù–´
-- ===============================

-- –ö–æ—Ä–∑–∏–Ω—ã –ø–æ–∫—É–ø–æ–∫
CREATE TABLE IF NOT EXISTS carts (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    user_telegram_id VARCHAR(50) NOT NULL,
    session_id VARCHAR(100),
    total_amount DECIMAL(10,2) DEFAULT 0,
    items_count INTEGER DEFAULT 0,
    currency VARCHAR(10) DEFAULT 'RUB',
    expires_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- –¢–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–∞—Ö
CREATE TABLE IF NOT EXISTS cart_items (
    id SERIAL PRIMARY KEY,
    cart_id INTEGER NOT NULL REFERENCES carts(id) ON DELETE CASCADE,
    product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    variant_id INTEGER REFERENCES product_variants(id),
    quantity INTEGER NOT NULL DEFAULT 1,
    price DECIMAL(10,2) NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    options JSON,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ó–∞–∫–∞–∑—ã
CREATE TABLE IF NOT EXISTS orders (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    user_telegram_id VARCHAR(50) NOT NULL,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    
    -- –°—É–º–º—ã
    subtotal DECIMAL(10,2) NOT NULL,
    tax_amount DECIMAL(10,2) DEFAULT 0,
    shipping_amount DECIMAL(10,2) DEFAULT 0,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    total_amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(10) DEFAULT 'RUB',
    
    -- –°—Ç–∞—Ç—É—Å
    status VARCHAR(50) DEFAULT 'pending',
    payment_status VARCHAR(50) DEFAULT 'pending',
    fulfillment_status VARCHAR(50) DEFAULT 'pending',
    
    -- –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞
    items JSON NOT NULL,
    
    -- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    customer_name VARCHAR(255),
    customer_phone VARCHAR(50),
    customer_email VARCHAR(255),
    
    -- –î–æ—Å—Ç–∞–≤–∫–∞
    shipping_method_id INTEGER REFERENCES shipping_methods(id),
    delivery_address TEXT,
    delivery_date DATE,
    delivery_time_slot VARCHAR(50),
    
    -- –û–ø–ª–∞—Ç–∞
    payment_method_id INTEGER REFERENCES payment_methods(id),
    
    -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
    notes TEXT,
    admin_notes TEXT,
    coupon_code VARCHAR(50),
    
    -- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    cancelled_at TIMESTAMP WITH TIME ZONE
);

-- –ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤
CREATE TABLE IF NOT EXISTS order_status_history (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    status VARCHAR(50) NOT NULL,
    comment TEXT,
    created_by VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 6. –°–ü–û–°–û–ë–´ –î–û–°–¢–ê–í–ö–ò –ò –û–ü–õ–ê–¢–´
-- ===============================

-- –°–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏
CREATE TABLE IF NOT EXISTS shipping_methods (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    free_shipping_threshold DECIMAL(10,2),
    delivery_time VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    position INTEGER DEFAULT 0,
    settings JSON,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã
CREATE TABLE IF NOT EXISTS payment_methods (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL,
    description TEXT,
    settings JSON,
    is_active BOOLEAN DEFAULT TRUE,
    position INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ö—É–ø–æ–Ω—ã –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã
CREATE TABLE IF NOT EXISTS coupons (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    code VARCHAR(50) NOT NULL,
    name VARCHAR(255),
    description TEXT,
    type VARCHAR(50) NOT NULL, -- percentage, fixed, free_shipping
    value DECIMAL(10,2) NOT NULL,
    minimum_amount DECIMAL(10,2),
    maximum_discount DECIMAL(10,2),
    usage_limit INTEGER,
    usage_count INTEGER DEFAULT 0,
    user_usage_limit INTEGER,
    starts_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—É–ø–æ–Ω–æ–≤
CREATE TABLE IF NOT EXISTS coupon_usages (
    id SERIAL PRIMARY KEY,
    coupon_id INTEGER NOT NULL REFERENCES coupons(id) ON DELETE CASCADE,
    order_id INTEGER NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    user_telegram_id VARCHAR(50) NOT NULL,
    discount_amount DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 7. –ö–û–ù–°–¢–†–£–ö–¢–û–† –ò –®–ê–ë–õ–û–ù–´
-- ===============================

-- –®–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
CREATE TABLE IF NOT EXISTS templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(100) NOT NULL,
    preview_image VARCHAR(500),
    blocks_data JSON NOT NULL,
    metadata JSON,
    is_public BOOLEAN DEFAULT TRUE,
    is_premium BOOLEAN DEFAULT FALSE,
    usage_count INTEGER DEFAULT 0,
    author_id INTEGER REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- –î–∏–∑–∞–π–Ω—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
CREATE TABLE IF NOT EXISTS designs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    shop_id INTEGER REFERENCES shops(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    design_data JSON NOT NULL,
    preview_image VARCHAR(500),
    is_template BOOLEAN DEFAULT FALSE,
    is_public BOOLEAN DEFAULT FALSE,
    category VARCHAR(100),
    tags JSON,
    version INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –±–ª–æ–∫–æ–≤
CREATE TABLE IF NOT EXISTS blocks_library (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(100) NOT NULL,
    category VARCHAR(100) NOT NULL,
    description TEXT,
    preview_image VARCHAR(500),
    block_data JSON NOT NULL,
    default_props JSON,
    is_premium BOOLEAN DEFAULT FALSE,
    usage_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 8. –§–ê–ô–õ–´ –ò –ú–ï–î–ò–ê
-- ===============================

-- –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
CREATE TABLE IF NOT EXISTS media_files (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    shop_id INTEGER REFERENCES shops(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    file_size INTEGER NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    url VARCHAR(500) NOT NULL,
    thumbnail_url VARCHAR(500),
    alt_text VARCHAR(255),
    description TEXT,
    folder VARCHAR(255),
    is_public BOOLEAN DEFAULT TRUE,
    usage_count INTEGER DEFAULT 0,
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 9. –ü–û–î–ü–ò–°–ß–ò–ö–ò –ë–û–¢–û–í
-- ===============================

-- –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ –±–æ—Ç–æ–≤ (–ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ –≤ Telegram)
CREATE TABLE IF NOT EXISTS bot_subscribers (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    telegram_user_id VARCHAR(50) NOT NULL,
    username VARCHAR(100),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    language_code VARCHAR(10),
    phone VARCHAR(50),
    
    -- –°—Ç–∞—Ç—É—Å
    is_active BOOLEAN DEFAULT TRUE,
    is_blocked BOOLEAN DEFAULT FALSE,
    is_vip BOOLEAN DEFAULT FALSE,
    
    -- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    last_interaction TIMESTAMP WITH TIME ZONE,
    interaction_count INTEGER DEFAULT 0,
    message_count INTEGER DEFAULT 0,
    
    -- –ü–æ–∫—É–ø–∫–∏
    orders_count INTEGER DEFAULT 0,
    total_spent DECIMAL(10,2) DEFAULT 0,
    average_order_value DECIMAL(10,2) DEFAULT 0,
    
    -- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏
    source VARCHAR(100),
    utm_source VARCHAR(100),
    utm_campaign VARCHAR(100),
    referrer_id VARCHAR(50),
    
    -- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    country VARCHAR(100),
    city VARCHAR(100),
    timezone VARCHAR(50),
    
    -- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    metadata JSON,
    preferences JSON,
    tags JSON,
    
    first_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE
);

-- ===============================
-- 10. –ê–ù–ê–õ–ò–¢–ò–ö–ê –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê
-- ===============================

-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π
CREATE TABLE IF NOT EXISTS analytics (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    event_type VARCHAR(100) NOT NULL,
    user_telegram_id VARCHAR(50),
    subscriber_id INTEGER REFERENCES bot_subscribers(id),
    session_id VARCHAR(100),
    
    -- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏—è
    page VARCHAR(255),
    product_id INTEGER REFERENCES products(id) ON DELETE SET NULL,
    category_id INTEGER REFERENCES shop_categories(id) ON DELETE SET NULL,
    order_id INTEGER REFERENCES orders(id) ON DELETE SET NULL,
    
    -- –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    event_data JSON,
    user_agent TEXT,
    ip_address VARCHAR(50),
    referrer VARCHAR(500),
    
    -- –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    country VARCHAR(100),
    city VARCHAR(100),
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –°–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ (–∫—ç—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
CREATE TABLE IF NOT EXISTS shop_analytics_summary (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER UNIQUE NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    
    -- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    total_visitors INTEGER DEFAULT 0,
    unique_visitors_today INTEGER DEFAULT 0,
    unique_visitors_week INTEGER DEFAULT 0,
    unique_visitors_month INTEGER DEFAULT 0,
    
    -- –ó–∞–∫–∞–∑—ã
    total_orders INTEGER DEFAULT 0,
    orders_today INTEGER DEFAULT 0,
    orders_week INTEGER DEFAULT 0,
    orders_month INTEGER DEFAULT 0,
    
    -- –í—ã—Ä—É—á–∫–∞
    total_revenue DECIMAL(12,2) DEFAULT 0,
    revenue_today DECIMAL(12,2) DEFAULT 0,
    revenue_week DECIMAL(12,2) DEFAULT 0,
    revenue_month DECIMAL(12,2) DEFAULT 0,
    
    -- –ö–æ–Ω–≤–µ—Ä—Å–∏–∏
    conversion_rate DECIMAL(5,2) DEFAULT 0,
    average_order_value DECIMAL(10,2) DEFAULT 0,
    
    -- –¢–æ–≤–∞—Ä—ã
    total_products INTEGER DEFAULT 0,
    out_of_stock_products INTEGER DEFAULT 0,
    
    -- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    last_updated TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 11. –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
-- ===============================

-- –®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
CREATE TABLE IF NOT EXISTS notification_templates (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER REFERENCES shops(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(100) NOT NULL,
    title VARCHAR(255),
    message TEXT NOT NULL,
    variables JSON,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE IF NOT EXISTS notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    shop_id INTEGER REFERENCES shops(id) ON DELETE CASCADE,
    type VARCHAR(100) NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    data JSON,
    is_read BOOLEAN DEFAULT FALSE,
    is_sent BOOLEAN DEFAULT FALSE,
    sent_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 12. –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –ò API
-- ===============================

-- API –∫–ª—é—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE IF NOT EXISTS api_keys (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    shop_id INTEGER REFERENCES shops(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    key_hash VARCHAR(255) NOT NULL,
    permissions JSON,
    last_used_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Webhooks
CREATE TABLE IF NOT EXISTS webhooks (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    url VARCHAR(500) NOT NULL,
    events JSON NOT NULL,
    secret VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    last_triggered_at TIMESTAMP WITH TIME ZONE,
    success_count INTEGER DEFAULT 0,
    failure_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –õ–æ–≥–∏ webhook-–æ–≤
CREATE TABLE IF NOT EXISTS webhook_logs (
    id SERIAL PRIMARY KEY,
    webhook_id INTEGER NOT NULL REFERENCES webhooks(id) ON DELETE CASCADE,
    event_type VARCHAR(100) NOT NULL,
    payload JSON NOT NULL,
    response_status INTEGER,
    response_body TEXT,
    error_message TEXT,
    delivered_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- 13. –ù–ê–°–¢–†–û–ô–ö–ò –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
-- ===============================

-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
CREATE TABLE IF NOT EXISTS system_settings (
    id SERIAL PRIMARY KEY,
    key VARCHAR(255) UNIQUE NOT NULL,
    value TEXT,
    type VARCHAR(50) DEFAULT 'string',
    description TEXT,
    is_public BOOLEAN DEFAULT FALSE,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE IF NOT EXISTS user_settings (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    key VARCHAR(255) NOT NULL,
    value TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(user_id, key)
);

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤
CREATE TABLE IF NOT EXISTS shop_settings (
    id SERIAL PRIMARY KEY,
    shop_id INTEGER NOT NULL REFERENCES shops(id) ON DELETE CASCADE,
    category VARCHAR(100) NOT NULL,
    key VARCHAR(255) NOT NULL,
    value TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(shop_id, category, key)
);

-- ===============================
-- 14. –õ–û–ì–ò –ò –ê–£–î–ò–¢
-- ===============================

-- –õ–æ–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
CREATE TABLE IF NOT EXISTS activity_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    shop_id INTEGER REFERENCES shops(id) ON DELETE SET NULL,
    action VARCHAR(255) NOT NULL,
    entity_type VARCHAR(100),
    entity_id INTEGER,
    description TEXT,
    ip_address VARCHAR(50),
    user_agent TEXT,
    data JSON,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –õ–æ–≥–∏ –æ—à–∏–±–æ–∫
CREATE TABLE IF NOT EXISTS error_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    shop_id INTEGER REFERENCES shops(id) ON DELETE SET NULL,
    error_type VARCHAR(100) NOT NULL,
    error_message TEXT NOT NULL,
    stack_trace TEXT,
    url VARCHAR(500),
    ip_address VARCHAR(50),
    user_agent TEXT,
    data JSON,
    is_resolved BOOLEAN DEFAULT FALSE,
    resolved_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ===============================
-- –ò–ù–î–ï–ö–°–´ –î–õ–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
-- ===============================

-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_users_telegram_id ON users(telegram_id);
CREATE INDEX IF NOT EXISTS idx_users_subscription_plan ON users(subscription_plan);
CREATE INDEX IF NOT EXISTS idx_telegram_profiles_telegram_id ON telegram_user_profiles(telegram_id);
CREATE INDEX IF NOT EXISTS idx_auth_codes_code ON auth_codes(code);
CREATE INDEX IF NOT EXISTS idx_auth_codes_expires_at ON auth_codes(expires_at);
CREATE INDEX IF NOT EXISTS idx_user_sessions_token ON user_sessions(session_token);
CREATE INDEX IF NOT EXISTS idx_user_sessions_expires_at ON user_sessions(expires_at);

CREATE INDEX IF NOT EXISTS idx_shops_user_id ON shops(user_id);
CREATE INDEX IF NOT EXISTS idx_shops_domain_slug ON shops(domain_slug);
CREATE INDEX IF NOT EXISTS idx_shops_is_published ON shops(is_published);

CREATE INDEX IF NOT EXISTS idx_products_shop_id ON products(shop_id);
CREATE INDEX IF NOT EXISTS idx_products_category_id ON products(category_id);
CREATE INDEX IF NOT EXISTS idx_products_is_available ON products(is_available);
CREATE INDEX IF NOT EXISTS idx_products_slug ON products(shop_id, slug);

CREATE INDEX IF NOT EXISTS idx_orders_shop_id ON orders(shop_id);
CREATE INDEX IF NOT EXISTS idx_orders_user_telegram_id ON orders(user_telegram_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
CREATE INDEX IF NOT EXISTS idx_orders_created_at ON orders(created_at);

CREATE INDEX IF NOT EXISTS idx_bot_subscribers_shop_id ON bot_subscribers(shop_id);
CREATE INDEX IF NOT EXISTS idx_bot_subscribers_telegram_user_id ON bot_subscribers(telegram_user_id);
CREATE UNIQUE INDEX IF NOT EXISTS idx_bot_subscribers_unique ON bot_subscribers(shop_id, telegram_user_id);

CREATE INDEX IF NOT EXISTS idx_analytics_shop_id ON analytics(shop_id);
CREATE INDEX IF NOT EXISTS idx_analytics_event_type ON analytics(event_type);
CREATE INDEX IF NOT EXISTS idx_analytics_created_at ON analytics(created_at);

CREATE INDEX IF NOT EXISTS idx_media_files_user_id ON media_files(user_id);
CREATE INDEX IF NOT EXISTS idx_media_files_shop_id ON media_files(shop_id);

-- ===============================
-- –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï
-- ===============================

-- –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫
INSERT INTO subscription_plans (name, description, price, duration_days, features, max_shops, max_products, max_orders) VALUES
('Free', '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω', 0.00, 365, '["–ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä", "1 –º–∞–≥–∞–∑–∏–Ω", "–î–æ 10 —Ç–æ–≤–∞—Ä–æ–≤"]', 1, 10, 50),
('Pro', '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω', 990.00, 30, '["–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä", "5 –º–∞–≥–∞–∑–∏–Ω–æ–≤", "–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤", "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"]', 5, -1, -1),
('Enterprise', '–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω', 2990.00, 30, '["–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏", "–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤", "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞", "API –¥–æ—Å—Ç—É–ø"]', -1, -1, -1)
ON CONFLICT DO NOTHING;

-- –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
INSERT INTO users (telegram_id, username, first_name, subscription_plan) VALUES 
('123456789', 'testuser', 'Test User', 'pro') 
ON CONFLICT (telegram_id) DO NOTHING;

-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏

-- ===============================
-- –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ö –¢–ê–ë–õ–ò–¶–ê–ú
-- ===============================

-- COMMENT ON DATABASE - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
-- TeleShop Constructor - –ü–æ–ª–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π SaaS –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è Telegram –º–∞–≥–∞–∑–∏–Ω–æ–≤

-- –ì–æ—Ç–æ–≤–æ! –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞.
-- –í–∫–ª—é—á–∞–µ—Ç 40+ —Ç–∞–±–ª–∏—Ü –¥–ª—è –≤—Å–µ—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ TeleShop Constructor 