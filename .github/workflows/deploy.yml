name: ğŸš€ Auto Deploy TeleShop

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸš€ Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        command_timeout: 30m
        script: |
          set -e
          echo "ğŸš€ Starting TeleShop deployment..."
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
          echo "ğŸ“¦ Installing system dependencies..."
          apt update || echo "Update failed, continuing..."
          apt install -y curl wget git build-essential python3 python3-pip python3-venv nodejs npm || echo "Some packages may already be installed"
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° PM2 ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
          if ! command -v pm2 &> /dev/null; then
            echo "ğŸ“¦ Installing PM2..."
            npm install -g pm2
          fi
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
          cd /opt/teleshop || {
            echo "âŒ Project directory not found, cloning..."
            cd /opt
            git clone https://github.com/Logan5064/teleshop.git
            cd teleshop
          }
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´
          echo "ğŸ“¥ Updating code from GitHub..."
          git fetch origin
          git reset --hard origin/main
          git pull origin main
          
          # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²
          echo "â¹ï¸ Stopping old processes..."
          pm2 delete all || echo "No processes to stop"
          sleep 5
          
          # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ² Ğ±Ğ¾Ğ»ĞµĞµ Ğ¼ÑĞ³ĞºĞ¾
          echo "ğŸ§¹ Cleaning ports..."
          lsof -ti:8000 | xargs kill -9 || echo "Port 8000 is free"
          lsof -ti:3000 | xargs kill -9 || echo "Port 3000 is free"
          sleep 2
          
          # Backend setup
          echo "ğŸ Setting up Backend..."
          cd /opt/teleshop/05-server-launchers/main
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
          if [ ! -d "venv" ]; then
            echo "Creating new virtual environment..."
            python3 -m venv venv
          fi
          
          # ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
          source venv/bin/activate
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          echo "ğŸ“¦ Installing Python dependencies..."
          pip install --upgrade pip --quiet
          pip install --quiet fastapi uvicorn sqlalchemy asyncpg psycopg2-binary
          pip install --quiet python-multipart python-jose passlib bcrypt
          pip install --quiet aiofiles python-dotenv aiogram
          pip install --quiet python-telegram-bot nest_asyncio
          
          # Frontend setup
          echo "âš›ï¸ Setting up Frontend..."
          cd /opt/teleshop/01-user-dashboard
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          echo "ğŸ“¦ Installing Node.js dependencies..."
          npm install --silent
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
          echo "ğŸ”¨ Building frontend..."
          npm run build
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ PM2 ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
          echo "âš™ï¸ Creating PM2 config..."
          cd /opt/teleshop
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [
              {
                name: 'teleshop-backend',
                script: 'python3',
                args: ['-m', 'uvicorn', 'api_server:app', '--host', '0.0.0.0', '--port', '8000'],
                cwd: '/opt/teleshop/05-server-launchers/main',
                interpreter: '/opt/teleshop/05-server-launchers/main/venv/bin/python',
                env: {
                  NODE_ENV: 'production',
                  PYTHONPATH: '/opt/teleshop/05-server-launchers/main:/opt/teleshop/05-server-launchers/config'
                },
                restart_delay: 3000,
                max_restarts: 10,
                error_file: '/var/log/teleshop-backend-error.log',
                out_file: '/var/log/teleshop-backend-out.log'
              },
              {
                name: 'teleshop-frontend',
                script: 'npm',
                args: ['start'],
                cwd: '/opt/teleshop/01-user-dashboard',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                },
                restart_delay: 3000,
                max_restarts: 10,
                error_file: '/var/log/teleshop-frontend-error.log',
                out_file: '/var/log/teleshop-frontend-out.log'
              }
            ]
          };
          EOF
          
          # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
          echo "ğŸ” Setting permissions..."
          chmod +x /opt/teleshop/05-server-launchers/main/venv/bin/python
          chown -R $USER:$USER /opt/teleshop || echo "Permission setting failed, continuing..."
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
          echo "ğŸš€ Starting applications..."
          pm2 start ecosystem.config.js
          
          # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿ÑƒÑĞº
          pm2 startup systemd -u root --hp /root || echo "PM2 startup setup failed, continuing..."
          pm2 save
          
          # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          echo "â³ Waiting for services to start..."
          sleep 15
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          pm2 status
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ
          echo "ğŸ” Checking services..."
          if curl -s http://localhost:8000/ > /dev/null; then
            echo "âœ… Backend is running on port 8000"
          else
            echo "âš ï¸ Backend may still be starting, check: pm2 logs teleshop-backend"
          fi
          
          if curl -s http://localhost:3000/ > /dev/null; then
            echo "âœ… Frontend is running on port 3000"
          else
            echo "âš ï¸ Frontend may still be starting, check: pm2 logs teleshop-frontend"
          fi
          
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸŒ Frontend: http://178.236.17.93:3000"
          echo "ğŸ”§ Backend: http://178.236.17.93:8000"
          echo "ğŸ“‹ Check logs with: pm2 logs" 