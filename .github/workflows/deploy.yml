name: ğŸš€ Auto Deploy TeleShop

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸš€ Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting TeleShop deployment..."
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
          cd /opt/teleshop || {
            echo "âŒ Project directory not found, cloning..."
            cd /opt
            git clone https://github.com/Logan5064/teleshop.git
            cd teleshop
          }
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´
          echo "ğŸ“¥ Updating code from GitHub..."
          git fetch origin
          git reset --hard origin/main
          git pull origin main
          
          # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²
          echo "â¹ï¸ Stopping old processes..."
          pm2 delete all || echo "No processes to stop"
          
          # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ²
          pkill -f ":8000" || echo "Port 8000 is free"
          pkill -f ":3000" || echo "Port 3000 is free"
          
          # Backend setup
          echo "ğŸ Setting up Backend..."
          cd /opt/teleshop/05-server-launchers/main
          
          # ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
          source venv/bin/activate || {
            echo "Creating new virtual environment..."
            python3 -m venv venv
            source venv/bin/activate
          }
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          pip install --upgrade pip
          pip install fastapi uvicorn sqlalchemy asyncpg psycopg2-binary
          pip install python-multipart python-jose passlib bcrypt
          pip install aiofiles python-dotenv aiogram
          pip install python-telegram-bot nest_asyncio
          
          # Frontend setup
          echo "âš›ï¸ Setting up Frontend..."
          cd /opt/teleshop/01-user-dashboard
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
          npm install
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
          npm run build
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ PM2 ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
          echo "âš™ï¸ Creating PM2 config..."
          cd /opt/teleshop
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [
              {
                name: 'teleshop-backend',
                script: 'python3',
                args: ['-m', 'uvicorn', 'api_server:app', '--host', '0.0.0.0', '--port', '8000'],
                cwd: '/opt/teleshop/05-server-launchers/main',
                interpreter: '/opt/teleshop/05-server-launchers/main/venv/bin/python',
                env: {
                  NODE_ENV: 'production',
                  PYTHONPATH: '/opt/teleshop/05-server-launchers/main:/opt/teleshop/05-server-launchers/config'
                },
                restart_delay: 3000,
                max_restarts: 10
              },
              {
                name: 'teleshop-frontend',
                script: 'npm',
                args: ['start'],
                cwd: '/opt/teleshop/01-user-dashboard',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000
                },
                restart_delay: 3000,
                max_restarts: 10
              }
            ]
          };
          EOF
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
          echo "ğŸš€ Starting applications..."
          pm2 start ecosystem.config.js
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ PM2
          pm2 save
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          sleep 10
          pm2 status
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ
          echo "ğŸ” Checking services..."
          if curl -s http://localhost:8000/ > /dev/null; then
            echo "âœ… Backend is running"
          else
            echo "âš ï¸ Backend may still be starting"
          fi
          
          if curl -s http://localhost:3000/ > /dev/null; then
            echo "âœ… Frontend is running"
          else
            echo "âš ï¸ Frontend may still be starting"
          fi
          
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸŒ Frontend: http://178.236.17.93:3000"
          echo "ğŸ”§ Backend: http://178.236.17.93:8000" 