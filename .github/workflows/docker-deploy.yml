name: ğŸ³ Docker Deploy TeleShop

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”‘ Deploy to server via Docker
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 178.236.17.93
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ğŸ¯ Starting TeleShop Docker deployment..."
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‡ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ¸Ğ»Ğ¸ ĞºĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
          if [ ! -d "/opt/teleshop" ]; then
            cd /opt
            git clone https://github.com/GTXFerrari/sitetest.git teleshop
          else
            cd /opt/teleshop
            git pull origin main
          fi
          
          cd /opt/teleshop
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Docker ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
          if ! command -v docker &> /dev/null; then
            echo "ğŸ³ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl start docker
            systemctl enable docker
          fi
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Docker Compose ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
          if ! command -v docker-compose &> /dev/null; then
            echo "ğŸ³ Installing Docker Compose..."
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
          fi
          
          echo "âœ… Docker Ğ¸ Docker Compose Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹"
          
          # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ ĞµÑÑ‚ÑŒ
          echo "ğŸ›‘ Stopping old containers..."
          docker-compose down || true
          
          # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑĞ±Ğ¾Ñ€ĞºĞ¸
          echo "ğŸ§¹ Cleaning old images..."
          docker system prune -f
          
          # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
          echo "ğŸš€ Building and starting containers..."
          docker-compose up --build -d
          
          # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
          echo "ğŸ“Š Checking container status..."
          docker-compose ps
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸
          echo "ğŸ“‹ Recent logs:"
          docker-compose logs --tail=20
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ
          echo "ğŸ” Checking services..."
          if curl -s http://localhost:8000/health > /dev/null; then
            echo "âœ… Backend is running on port 8000"
          else
            echo "âš ï¸ Backend health check failed"
            docker-compose logs backend
          fi
          
          if curl -s http://localhost:3000 > /dev/null; then
            echo "âœ… Frontend is running on port 3000"
          else
            echo "âš ï¸ Frontend health check failed"
            docker-compose logs frontend
          fi
          
          echo "ğŸ‰ TeleShop Docker deployment completed!"
          echo "ğŸŒ Frontend: http://178.236.17.93:3000"
          echo "ğŸ”§ Backend: http://178.236.17.93:8000"
          echo "ğŸ“š API Docs: http://178.236.17.93:8000/secure/docs" 