#!/bin/bash

# ============================================================================
# üöÄ –ü–†–û–ò–ó–í–û–î–°–¢–í–ï–ù–ù–´–ô –î–ï–ü–õ–û–ô TELESHOP CONSTRUCTOR
# –°–µ—Ä–≤–µ—Ä: 178.236.17.93
# –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è backend - –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ
# ============================================================================

set -e
set -u

# –¶–≤–µ—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

SERVER_IP="178.236.17.93"
SERVER_USER="root"
DEPLOY_PATH="/opt/teleshop"
SSH_KEY_PATH="~/.ssh/id_rsa"
PROJECT_NAME="teleshop-constructor"

# ============================================================================
# –®–ê–ì 1: –ü–û–î–ì–û–¢–û–í–ö–ê –õ–û–ö–ê–õ–¨–ù–û–ì–û –ü–†–û–ï–ö–¢–ê
# ============================================================================

log_info "üéØ –ù–∞—á–∏–Ω–∞—é production –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä $SERVER_IP"
log_info "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [[ ! -f "package.json" ]] || [[ ! -d "01-user-dashboard" ]] || [[ ! -d "05-server-launchers" ]]; then
    log_error "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ TeleShop"
    exit 1
fi

log_success "‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"

# –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ backend –ª–æ–∫–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –≤—ã—à–µ)
log_success "‚úÖ Backend –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"

# ============================================================================
# –®–ê–ì 2: –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£ –ò –ü–û–î–ì–û–¢–û–í–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø  
# ============================================================================

log_info "üîó –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É $SERVER_IP..."

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –¥–µ–ø–ª–æ—è
ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'REMOTE_SETUP'
    # –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –ø–∞–ø–∫—É
    mkdir -p /opt/teleshop
    cd /opt/teleshop
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É
    apt-get update
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js 18+
    if ! command -v node &> /dev/null || [[ $(node -v | cut -d'v' -f2 | cut -d'.' -f1) -lt 18 ]]; then
        echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Node.js 18..."
        curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
        apt-get install -y nodejs
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python 3.11+
    if ! command -v python3.11 &> /dev/null; then
        echo "üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é Python 3.11..."
        apt-get install -y software-properties-common
        add-apt-repository ppa:deadsnakes/ppa -y
        apt-get update
        apt-get install -y python3.11 python3.11-venv python3.11-dev python3-pip
        
        # –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
        ln -sf /usr/bin/python3.11 /usr/bin/python3
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –≥–ª–æ–±–∞–ª—å–Ω–æ
    if ! command -v pm2 &> /dev/null; then
        echo "‚ö° –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é PM2..."
        npm install -g pm2
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PostgreSQL –∫–ª–∏–µ–Ω—Ç
    apt-get install -y postgresql-client
    
    echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
REMOTE_SETUP

log_success "‚úÖ –°–µ—Ä–≤–µ—Ä –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω"

# ============================================================================
# –®–ê–ì 3: –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í –ü–†–û–ï–ö–¢–ê
# ============================================================================

log_info "üì§ –ö–æ–ø–∏—Ä—É—é —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç
rsync -avz --progress \
    --exclude='node_modules' \
    --exclude='.next' \
    --exclude='venv' \
    --exclude='__pycache__' \
    --exclude='.git' \
    --exclude='*.log' \
    --exclude='–ù–æ–≤–∞—è –ø–∞–ø–∫–∞' \
    --exclude='offconstryktor' \
    . $SERVER_USER@$SERVER_IP:$DEPLOY_PATH/

log_success "‚úÖ –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

# ============================================================================
# –®–ê–ì 4: –ù–ê–°–¢–†–û–ô–ö–ê BACKEND (PYTHON)
# ============================================================================

log_info "üêç –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é Python backend..."

ssh $SERVER_USER@$SERVER_IP << 'BACKEND_SETUP'
    cd /opt/teleshop/05-server-launchers/main
    
    # –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    python3.11 -m venv venv
    source venv/bin/activate
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    pip install --upgrade pip
    pip install -r requirements.txt
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    python -c "import api_server; print('‚úÖ Backend –º–æ–¥—É–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ')"
    
    echo "‚úÖ Python backend –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
BACKEND_SETUP

log_success "‚úÖ Backend –≥–æ—Ç–æ–≤"

# ============================================================================
# –®–ê–ì 5: –ù–ê–°–¢–†–û–ô–ö–ê FRONTEND (NEXT.JS)
# ============================================================================

log_info "‚öõÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é Next.js frontend..."

ssh $SERVER_USER@$SERVER_IP << 'FRONTEND_SETUP'
    cd /opt/teleshop/01-user-dashboard
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    npm ci --legacy-peer-deps
    
    # –°–±–æ—Ä–∫–∞ –¥–ª—è production
    NODE_ENV=production npm run build
    
    echo "‚úÖ Frontend —Å–æ–±—Ä–∞–Ω –¥–ª—è production"
FRONTEND_SETUP

log_success "‚úÖ Frontend –≥–æ—Ç–æ–≤"

# ============================================================================
# –®–ê–ì 6: –ù–ê–°–¢–†–û–ô–ö–ê PM2 –ò –ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í
# ============================================================================

log_info "‚ö° –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."

# –°–æ–∑–¥–∞–µ–º PM2 ecosystem
ssh $SERVER_USER@$SERVER_IP << 'PM2_SETUP'
    cd /opt/teleshop
    
    # –°–æ–∑–¥–∞–µ–º PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'teleshop-backend',
      script: '/opt/teleshop/05-server-launchers/main/venv/bin/python',
      args: '/opt/teleshop/05-server-launchers/main/api_server.py',
      cwd: '/opt/teleshop/05-server-launchers/main',
      interpreter: 'none',
      env: {
        NODE_ENV: 'production',
        PYTHONPATH: '/opt/teleshop/05-server-launchers/main'
      },
      instances: 1,
      exec_mode: 'fork',
      watch: false,
      max_memory_restart: '1G',
      log_file: '/var/log/teleshop-backend.log',
      error_file: '/var/log/teleshop-backend-error.log',
      out_file: '/var/log/teleshop-backend-out.log',
      time: true,
      restart_delay: 5000,
      max_restarts: 10
    },
    {
      name: 'teleshop-frontend',  
      script: 'npm',
      args: 'start',
      cwd: '/opt/teleshop/01-user-dashboard',
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      },
      instances: 1,
      exec_mode: 'fork',
      watch: false,
      max_memory_restart: '2G',
      log_file: '/var/log/teleshop-frontend.log',
      error_file: '/var/log/teleshop-frontend-error.log',
      out_file: '/var/log/teleshop-frontend-out.log',
      time: true
    }
  ]
};
EOF
    
    echo "‚úÖ PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞"
PM2_SETUP

# ============================================================================
# –®–ê–ì 7: –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================================================================

log_info "üöÄ –ó–∞–ø—É—Å–∫–∞—é TeleShop Constructor..."

ssh $SERVER_USER@$SERVER_IP << 'START_SERVICES'
    cd /opt/teleshop
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    pm2 delete all 2>/dev/null || true
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã
    pm2 start ecosystem.config.js
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
    pm2 save
    pm2 startup
    
    echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã —á–µ—Ä–µ–∑ PM2"
    
    # –ñ–¥–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    sleep 10
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    pm2 status
START_SERVICES

# ============================================================================
# –®–ê–ì 8: –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò
# ============================================================================

log_info "üîç –ü—Ä–æ–≤–µ—Ä—è—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤..."

# –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
sleep 15

# –ü—Ä–æ–≤–µ—Ä—è–µ–º backend
if curl -s "http://$SERVER_IP:8000/health" > /dev/null; then
    log_success "‚úÖ Backend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ http://$SERVER_IP:8000"
else
    log_warning "‚ö†Ô∏è Backend –Ω–∞ –ø–æ—Ä—Ç—É 8000 –µ—â–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è..."
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend
if curl -s "http://$SERVER_IP:3000" > /dev/null; then
    log_success "‚úÖ Frontend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ http://$SERVER_IP:3000"
else
    log_warning "‚ö†Ô∏è Frontend –Ω–∞ –ø–æ—Ä—Ç—É 3000 –µ—â–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è..."
fi

# ============================================================================
# –§–ò–ù–ê–õ
# ============================================================================

log_success "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù!"
log_info "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
log_info "üåê Frontend:        http://$SERVER_IP:3000"
log_info "üîß Backend API:     http://$SERVER_IP:8000"
log_info "üìö API Docs:        http://$SERVER_IP:8000/secure/docs"
log_info "üîê Auth Login:      http://$SERVER_IP:8000/auth/login"
log_info "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
log_info "üìä –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: ssh $SERVER_USER@$SERVER_IP 'pm2 monit'"
log_info "üìã –õ–æ–≥–∏ backend:    ssh $SERVER_USER@$SERVER_IP 'pm2 logs teleshop-backend'"
log_info "üìã –õ–æ–≥–∏ frontend:   ssh $SERVER_USER@$SERVER_IP 'pm2 logs teleshop-frontend'"
log_info "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
ssh $SERVER_USER@$SERVER_IP 'cd /opt/teleshop && pm2 status'

log_success "üöÄ TeleShop Constructor —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ production —Å–µ—Ä–≤–µ—Ä–µ!" 